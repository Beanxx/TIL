2022.06.26(Sun)
[TIL] Day43

> ì´ë²ˆ ì£¼ë§ì—ëŠ” expressë¡œ server-API-CRUDë¥¼ êµ¬í˜„í•´ì„œ ì €ë²ˆì£¼ì— ì§„í–‰í–ˆë˜ React-CRUD-clientì— fetchë¥¼ í†µí•´ ì—°ê²°í•´ë³´ëŠ” ì‘ì—…ì„ ì§„í–‰í–ˆë‹¤.<br/>
> ë¯¸ë£¨ë‹¤ ë¯¸ë£¨ë‹¤ ì•„ì§ë„ ìˆ˜ì • ê¸°ëŠ¥ì¸ UPDATEëŠ” êµ¬í˜„ ëª»í•¨... í•´ì•¼í•˜ëŠ”ë° ì½”ë“œê°€ ë„ˆë¬´ ì¤‘êµ¬ë‚œë°©ì´ë¼ í•œë²ˆ ì»´í¬ë„ŒíŠ¸ êµ¬ì¡° ì¢€ ì‹¹ ê°ˆì•„ì—ì€ í›„ì— ì§„í–‰í•´ì•¼ í• ë“¯ ì‹¶ë‹¤..ğŸ« 

### ğŸ“ í´ë” êµ¬ì¡°

- CRUD-PROJECT
  - crud-client
    - components
      - ContentItem.js
      - ContentList.js
      - Editor.js
    - App.js
  - crud-server
    - repository/diaryData.js
    - router/diaryRouter.js
    - controller/index.js
    - app.js

<br/>

### ğŸ“ crud-server

```js
// app.js
const express = require("express");
const app = express();
const cors = require("cors");
const morgan = require("morgan");
const port = 3001;

app.use(cors()); // cors middleware ì ìš©
app.use(express.json()); // Express ë‚´ì¥ ë¯¸ë“¤ì›¨ì–´ ì ìš©
app.use(morgan("tiny")); // HTTP ìš”ì²­ loggerì¸ morgan ì ìš©

// Routing
const diaryRouter = require("./router/diaryRouter");
app.use("/diary", diaryRouter);

// Response
app.get("/", (req, res) => {
  res.status(200).send("My Diary!~!");
});

app.use((req, res, next) => {
  res.status(404).send("Not Found!");
});

const server = app.listen(port, () => {
  console.log(`[RUN] My CRUD diary Server... | http://localhost:${port}`);
});

module.exports.app = app;
module.exports.server = server;
```

```js
// router/diaryRouter.js
// TODO: discussions ë¼ìš°í„°ë¥¼ ì™„ì„±í•©ë‹ˆë‹¤.\
const { diaryController } = require("../controller");
const { findAll, findById, createOne, updateById, deleteById } =
  diaryController;
const express = require("express");
const router = express.Router();

// http://localhost:3001/diary/

router.get("/", findAll); // ëª¨ë“  ëª©ë¡ ì¡°íšŒ Router
router.get("/:id", findById); // ê¸€ í•˜ë‚˜ ì¡°íšŒ Router
router.post("/", createOne); // ê¸€ í•˜ë‚˜ ìƒì„± Router
router.put("/:id", updateById); // ê¸€ í•˜ë‚˜ ìˆ˜ì • Router
router.delete("/:id", deleteById); // ê¸€ í•˜ë‚˜ ì‚­ì œ Router

module.exports = router;
```

```js
// controller/index.js
const { diaryDummyData } = require("../repository/diaryData");
const diaryData = diaryDummyData;
const diaryController = {
  // router.get("/", findAll);
  findAll: (req, res) => {
    return res.status(200).json(diaryData);
  },

  // router.get("/:id", findById);
  findById: (req, res) => {
    // path-parameterê°€ ìˆë‹¤ë©´
    if (req.params) {
      // filter ëŒ€ì‹  find ë©”ì†Œë“œ ì‚¬ìš©
      const idx = diaryData.find((item) => item.id === Number(req.params.id));
      // ì¡°íšŒí•˜ë ¤ëŠ” idê°€ ìˆë‹¤ë©´ ì‘ë‹µ
      if (idx !== undefined) {
        res.status(200).json(idx);
      }
    }
    res.status(404).send("Not found!!");
  },

  // router.post("/", createOne);
  createOne: (req, res) => {
    const newItem = req.body;
    // unshift()ë¡œ ìƒì„±ëœ dataë¥¼ diaryData ì•ì— ì¶”ê°€
    diaryData.unshift(newItem);
    return res.status(200).send("Create Diary!!");
  },

  // router.put("/:id", updateById);
  updateById: (req, res) => {
    const updated = diaryData.filter((item) => item.id === Number(req.body.id));
    // //updatedëŠ” ë°°ì—´ ì•ˆì— ê°ì²´ê°€ ìˆëŠ” í˜•íƒœì´ë¯€ë¡œ index:[0]ì„ ê°€ì ¸ì˜´
    // ìˆ˜ì •í•œ ë‚´ìš©ì„ bodyì— ë¶™ì—¬ì„œ ìˆ˜ì •
    const change = { ...updated[0], ...req.body }; // updateí•  data
    // findIndex() ë©”ì†Œë“œë¡œ idê°€ ì¼ì¹˜í•˜ëŠ” dataì˜ indexë¥¼ êµ¬í•¨
    const idx = diaryData.findIndex(
      (item) => item.id === Number(req.params.id)
    );

    // splice(): ìƒˆ ìš”ì†Œë¥¼ ì¶”ê°€í•˜ì—¬ ë°°ì—´ ë‚´ìš© ë³€ê²½
    // splice(start index, deleteCount, item)
    diaryData.splice(idx, 1, change);
    return res.status(200).json(change);
  },

  // router.delete("/:id", deleteById);
  deleteById: (req, res) => {
    const deleted = diaryData.findIndex(
      (item) => item.id === Number(req.params.id)
    );
    // splice(): ë°°ì—´ì˜ ê¸°ì¡´ ìš”ì†Œ ì‚­ì œ
    diaryData.splice(deleted, 1);
    return res.status(200).json();
  },
};

module.exports = {
  diaryController,
};
```

<br/>

### ğŸ“ crud-client

```js
// fetchìª½ ì½”ë“œë§Œ ì‚´í´ë³´ê¸° Ù©( á› )Ùˆ

function App() {
  const url = "http://localhost:3001/diary";
  const [data, setData] = useState([]);

  // ì²˜ìŒ ë Œë”ë§ë  ë•Œë§Œ fetch ì ìš©
  useEffect(() => {
    getDiary();
  }, []);

  // fetchë¡œ serverì—ì„œ data ê°€ì ¸ì˜¤ëŠ” function'
  const getDiary = () => {
    fetch(url)
      .then((res) => res.json()) // json í˜•ì‹ìœ¼ë¡œ data ê°€ì ¸ì˜¤ê¸°
      .then((data) => setData(data)); // data ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ ì‹¤í–‰
  };


  // Create-ê¸€ ì¶”ê°€
  const onCreate = (title, content) => {
    const createdAt = new Date().toLocaleDateString();
    const newItem = {
      id: dataId.current,
      username: "SooBin",
      title,
      content,
      createdAt,
    };
    dataId.current += 1;
    setData([newItem, ...data]);

    fetch(url, {
      method: "POST",  // ìƒì„± ë©”ì†Œë“œ ì ìš©
      headers: {
        // client->serverë¡œ ìš”ì²­ì‹œ json ë°ì´í„° í˜•ì‹ ê¶Œì¥ ì˜ë¯¸
        "Accept": "application/json",
        // í˜„ì¬ ì „ì†¡í•˜ëŠ” ë°ì´í„°ê°€ jsonì„ì„ ì˜ë¯¸
        "Content-Type": "application/json",
      },
      // json í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      body: JSON.stringify(newItem),
    }).then((res) => {
      if (res.status === 201) {
        getDiary();
      }
    });
  };


  // Delete-ê¸€ ì‚­ì œ
  const onDelete = () => {
    const deletedDiary = data.filter((item) => item.id !== Number(id));
    setData(deletedDiary);
    setIsTitleClick(false);
    fetch(url + `/${id}`, {
      method: "DELETE", // ì‚­ì œ ë©”ì†Œë“œ ì ìš©
    }).then((res) => {
      // 202 status: ìš”ì²­ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ & ì•„ì§ í•´ë‹¹ ìš”ì²­ì— ëŒ€í•´ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì²˜ë¦¬ ì‹œì‘ ì „
      // 204 status: ìš”ì²­ì´ ì„±ê³µ & clientê°€ í˜„ì¬ í˜ì´ì§€ì—ì„œ ë²—ì–´ë‚˜ì§€ ì•Šì•„ë„ ë¨ì„ ì˜ë¯¸
      if (res.status === 202 || 204) {
        getDiary();
      }
    });
  };

  ...
}

export default App;
```

<br/>
> ìš”ë¡œì½¤ ì ìš©í•˜ë©´ React client í˜ì´ì§€ì—ì„œ ìƒˆë¡œê³ ì¹¨í•´ë„ ê¸€ì„ ìƒì„±, ì‚­ì œí•œ ê²ƒì´ ê³ ëŒ€ë¡œ ë‚¨ì•„ìˆëŒœ ğŸ™Œ
